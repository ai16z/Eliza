name: Block Minified JavaScript/TypeScript

on:
    pull_request:
        branches: ["main", "develop", "*"] # Adjust as needed
    push:
        branches: ["main", "develop", "*"] # If you also want to scan direct pushes

jobs:
    block-minified-code:
        runs-on: ubuntu-latest
        steps:
            - name: Check out code
              uses: actions/checkout@v4

            - name: Detect potential minified code
              shell: bash
              run: |
                  echo "Scanning for potential minified JS/TS code..."
                  # Find .ts, .tsx, .js, .jsx files; skip common directories like node_modules, dist, build, etc.
                  FILES=$(find . \
                    \( -name 'node_modules' -prune \) -o \
                    \( -name 'dist' -prune \) -o \
                    \( -name 'build' -prune \) -o \
                    -type f \( -name '*.ts' -o -name '*.tsx' -o -name '*.js' -o -name '*.jsx' \) \
                    -print)

                  if [ -z "$FILES" ]; then
                    echo "No relevant JS/TS files found."
                    exit 0
                  fi

                  # Define a threshold for line length.
                  # Lines exceeding this length are considered potentially minified.
                  THRESHOLD=500
                  VIOLATIONS=0

                  for file in $FILES; do
                    # Check if any line in the file exceeds $THRESHOLD characters.
                    if grep -qE ".{$THRESHOLD,}" "$file"; then
                      echo "::error file=$file::Detected potential minified code (line length > $THRESHOLD)."
                      VIOLATIONS=1
                    fi
                  done

                  if [ "$VIOLATIONS" -eq 1 ]; then
                    echo "ERROR: Minified code detected. Please remove or exclude it."
                    exit 1
                  else
                    echo "No minified code detected."
                  fi
